'''
Created on Mar 9, 2011

@author: tcezard
'''
from utils import utils_logging,utils_commands
from IO_interface import vcfIO, samIterator
import sys, os
import pprint



def fix_bam_read_group(bam_file):
    command="samtools view -h %s"%(bam_file)
    stream,process = utils_commands.get_output_stream_from_command(command)
    header_lines=[]
    previous_record=None
    for line in stream:
        if line.startswith("@"):
            print line.strip()
            continue
        sam_record=samIterator.Sam_record(line.strip())
        if previous_record:
            if previous_record.get_query_name()==sam_record.get_query_name():
                if previous_record.is_first_read():
                    read1=previous_record
                    read2=sam_record
                else:
                    read2=previous_record
                    read1=sam_record
                read2.set_tag("RG","Z",read1.get_tag("RG"))
                sys.stdout.write(str(read1))
                sys.stdout.write(str(read2))
                previous_record=None
            else:
                sys.stdout.write(str(previous_record))
                previous_record=sam_record
        else:
            previous_record=sam_record



if __name__=="__main__":
    input_file = sys.argv[1]
    fix_bam_read_group(input_file)
