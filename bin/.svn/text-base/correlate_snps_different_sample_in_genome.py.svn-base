'''
Created on 4 Mar 2010

@author: tcezard
'''
from utils.FastaFormat import FastaReader, FastaWriter
from utils import utils_logging

def corelate_snps_file():
    #Escherichia_coli_O157:H7_EDL933 23453   A       178     C       A:2     C:165   G:0     T:0     F:8
    #Escherichia_coli_O157:H7_EDL933 26735   T       52      A       A:15    C:1     G:0     T:16    F:20
    all_snps_position={}
    genome_file='/home/tcezard/genomes/escherichia_coli/O157H7_EDL933/E_Coli_O157H7_EDL933.fasta'
    genome_out_file='/home/tcezard/projects/20100126_8_Ecoli/new_genome_EDL933_2.fasta'
    concordante_snps_out_file='/home/tcezard/projects/20100126_8_Ecoli/concordant_snps_7_samples_EDL933.txt'
    all_input_files=['/home/tcezard/projects/20100126_8_Ecoli/6991/BFAST/6991_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7208/BFAST/7208_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7219/BFAST/7219_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7636/BFAST/7636_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7864/BFAST/7864_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7902/BFAST/7902_snps_m30_q20.txt',
                     '/home/tcezard/projects/20100126_8_Ecoli/7925/BFAST/7925_snps_m30_q20.txt']
    for input_file in all_input_files:
        open_input=utils_logging.open_input_file(input_file)
        for line in open_input:
            sp_line=line.strip().split()
            position_dict=all_snps_position.get(sp_line[0])
            if position_dict is None:
                position_dict={}
                all_snps_position[sp_line[0]]=position_dict
            snps_dict=position_dict.get(int(sp_line[1]))
            if snps_dict is None:
                snps_dict={'A':0,'T':0,'C':0,'G':0}
                position_dict[int(sp_line[1])]=snps_dict
            snps_dict[sp_line[4].upper()]+=1
    open_genome=open(genome_file)
    open_output_genome=open(genome_out_file,'w')
    open_concor_snps_out_file=open(concordante_snps_out_file,'w')
    fasta_reader=FastaReader(open_genome)
    fasta_writer=FastaWriter(open_output_genome, 60)
    for fasta_entry in fasta_reader:
        header, sequence=fasta_entry
        chr=header.strip()
        if all_snps_position.has_key(chr):
            fasta_writer.start_sequence(chr)
            positions_dict=all_snps_position.get(chr)
            all_positions=positions_dict.keys()
            all_positions.sort()
            last_position=0
            base_written=0
            base_change=0
            for position in all_positions:
                snps_dict=positions_dict.get(position)
                #Change position to 0-base
                position_minus_one=position-1
                
                sorted_list=sorted(snps_dict, key=lambda x: snps_dict[x], reverse=True)
                #print snps_dict.get(sorted_list[0]), len(all_input_files)
                if snps_dict.get(sorted_list[0])==len(all_input_files):
                    if last_position<position:
                        fasta_writer.write_sequence(sequence[last_position:position_minus_one])
                        base_written+=len(sequence[last_position:position_minus_one])
                    fasta_writer.write_sequence(sorted_list[0])
                    base_written+=1
                    base_change+=1
                    open_concor_snps_out_file.write('%s\t%s\t%s\t%s\n'%(chr, position, sequence[position_minus_one], sorted_list[0]))
                else:
                    fasta_writer.write_sequence(sequence[last_position:position_minus_one+1])
                    base_written+=len(sequence[last_position:position_minus_one+1])
                last_position=position_minus_one+1
            if last_position<len(sequence):
                fasta_writer.write_sequence(sequence[last_position:len(sequence)])
                base_written+=len(sequence[last_position:len(sequence)])
        print '%s: %s bases changed'%(chr,base_change) 
    fasta_writer.close()
    open_concor_snps_out_file.close()
    
    
    
corelate_snps_file()
