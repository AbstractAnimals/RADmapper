'''
Created on 22 Jun 2010

@author: tcezard
'''
from utils.utils_logging import open_input_file
import logging
from utils import DNA_tools
import SNPs

def read_line_snv_std(sp_line):
    try:
        pos=2
        chr=sp_line[0]
        if sp_line[1].isdigit():
            coordinate=int(sp_line[1])
        else:
            logging.error("coordinate is not a number at %s"%('\t'.join(sp_line)))
            return None
        if len(sp_line)>pos:
            ref_base=sp_line[pos].upper()
        else:
            logging.error("the reference base is not provided at line %s"%('\t'.join(sp_line)))
            return None
            
        if not DNA_tools.base_complement.has_key(ref_base):
            logging.error("the reference base  %s in column %s is not a nucleotide"%(ref_base,pos))
            return None
        
        if len(sp_line)>pos+1:
            IUPAC_code=sp_line[pos+1].upper()
        else:
            logging.error("the IUPAC code is not provided at line %s"%('\t'.join(sp_line)))
            return None
        if not SNPs.is_IUPAC_code(IUPAC_code):
            logging.error("the snv base %s in column %s is not a IUPAC code"%(IUPAC_code,pos+1))
            return None
        snvs_bases=SNPs.get_nt_array_from_IUPAC(IUPAC_code)
        if ref_base in snvs_bases:
            snvs_bases.remove(ref_base)
        return (chr,coordinate,ref_base,snvs_bases, '\t'.join(sp_line[pos+2:]))
    except Exception,e:
        return None

def snps_cocordance(snps_file_list):
    all_snps={}
    for file in snps_file_list:
        open_file=open_input_file(file, pipe=False)
        for line in open_file:
            snv_info=read_line_snv_std(line.split())
            if snv_info:
                (chr, coordinate, ref_base, snv_bases, other)=snv_info
                snp_list=all_snps.get('%s=%s'%(chr,coordinate))
                if not snp_list:
                    snp_list=[]
                    all_snps['%s=%s'%(chr,coordinate)]=snp_list
                snp_list.append((snv_bases,file))
        open_file.close()
    concordance={}
    for coordinate in all_snps.keys():
        snp_list=all_snps.get(coordinate)
        files=[]
        for (snv_bases,file) in snp_list:
            files.append(file)
        files.sort()
        
        nb=concordance.get('\t'.join(files))
        if nb is None:
            concordance['\t'.join(files)]=[(coordinate,snv_bases)]
        else:
            concordance['\t'.join(files)].append((coordinate,snv_bases))
    
    for files_str in concordance.keys():
        files=files_str.split('\t')
        print '%s snps are concordant in between %s '%(len(concordance.get(files_str)), ' and '.join(files))
        if len(files)==1:
            file=files[0]
            output_file=file+'.uniq'
            open_output=open(output_file,'w')
            for (coordinate,snv_bases) in concordance.get(files_str):
                chr, coord=coordinate.split('=')
                open_output.write('%s\t%s\t%s\n'%(chr, coord, '--'.join(snv_bases)))
            open_output.close()
    
            
snps_file_list=['/home/tcezard/projects/solid_trial_ecoli/20100126_8_Ecoli/6991/Corona_lite/20100126_8_Ecoli_6991_F3.csfasta.ma.50.6.annotated.gff3_snp_q20_m30.txt',
                #'/home/tcezard/projects/solid_trial_ecoli/20100126_8_Ecoli/6991/reads_fixed/6991_merged_snp_q20_m30.txt',
                '/home/tcezard/projects/solid_trial_ecoli/illumina_e_coli/6991/bwa/s_8_sequence_6991_sorted_snp_q20_m30.txt']
snps_file_list=['/home/tcezard/projects/solid_trial_ecoli/20100126_8_Ecoli/7219/Corona_lite/20100126_8_Ecoli_7219_F3.csfasta.ma.50.6.annotated.gff3_snp_q20_m30.txt',
                '/home/tcezard/projects/solid_trial_ecoli/illumina_e_coli/7219/bwa/s_8_sequence_7219_sorted_snp_q20_m30.txt']
#snps_file_list=['/home/tcezard/projects/solid_trial_ecoli/20100126_8_Ecoli/7636/Corona_lite/20100126_8_Ecoli_7636_F3.csfasta.ma.50.6.annotated.gff3_snp_q20_m30.txt',
#                '/home/tcezard/projects/solid_trial_ecoli/illumina_e_coli/7636/bwa/s_8_sequence_7636_sorted_snp_q20_m30.txt']
#snps_file_list=['/home/tcezard/projects/solid_trial_ecoli/20100126_8_Ecoli/7902/Corona_lite/20100126_8_Ecoli_7902_F3.csfasta.ma.50.6.annotated.gff3_snp_q20_m30.txt',
#                '/home/tcezard/projects/solid_trial_ecoli/illumina_e_coli/7902/bwa/s_8_sequence_7902_sorted_snp_q20_m30.txt']

snps_cocordance(snps_file_list)
